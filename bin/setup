#!/usr/bin/env php
<?php

require_once 'vendor/autoload.php';

$projectRootDir = __DIR__ . '/../../../..';

if (file_exists($projectRootDir . '/app/bootstrap.php')) {
    require $projectRootDir . '/app/bootstrap.php';
}

use Doctrine\Common\Annotations\AnnotationRegistry;
use Sitewards\Setup\Command\Page\Dump;
use Sitewards\Setup\Repository\PageRepository;
use Sitewards\Setup\Service\Page\Dumper\Dumper;
use Symfony\Component\Console\Application;
use Symfony\Component\Filesystem\Filesystem;

use Sitewards\Setup\Service\Page\Importer;
use Sitewards\Setup\Command\Page\Import;

AnnotationRegistry::registerAutoloadNamespace(
    'JMS\Serializer\Annotation',
    'vendor/jms/serializer/src'
);

$serializer = \JMS\Serializer\SerializerBuilder::create()->build();

$coreCliApplication = new \Magento\Framework\Console\Cli();
$objectManager      = \Magento\Framework\App\ObjectManager::getInstance();

$mage2Bridge = new PageRepository(
    $objectManager->get('\Magento\Cms\Api\PageRepositoryInterface'),
    $objectManager->get('\Magento\Framework\Api\SearchCriteriaBuilder'),
    $objectManager->get('\Magento\Cms\Api\Data\PageInterfaceFactory')
);

$dumper = new Dumper(
    $mage2Bridge,
    $serializer,
    new Filesystem()
);

$application = new Application();
$application->add(
    new Dump($dumper)
);

$importer = new Importer(
    $mage2Bridge,
    $serializer
);

$application->add(
    new Import($importer)
);
$application->run();
